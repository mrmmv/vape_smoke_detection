<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#001f3f">
    <title>DetectNic</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/256/998/998699.png" type="image/png">
    <style>
        /* General Styles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* App Container */
        .app-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Status Bar (for Android) */
        .status-bar {
            height: 24px;
            background: #001a33;
            width: 100%;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: #001f3f;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .top-nav .logo {
            width: 32px;
            height: 32px;
            margin-right: 12px;
        }

        .top-nav h1 {
            margin: 0;
            font-size: 1.2rem;
            color: white;
            font-weight: 500;
            flex: 1;
        }

        .top-nav .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            margin-right: 8px;
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 0.75rem;
            padding: 4px 12px;
        }

        .nav-item.active {
            color: #001f3f;
        }

        .nav-icon {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 70px; /* Space for bottom nav */
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.1rem;
            color: #001f3f;
            font-weight: 500;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background-color: #f5f5f5;
            color: #333;
            font-weight: 500;
        }

        #recent-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            object-fit: cover;
            margin-bottom: 12px;
        }

        .view-all-btn {
            background: #001f3f;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .view-all-btn:active {
            background: #003366;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #001f3f;
            margin: 4px 0;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        /* Developer Info */
        .developer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .developer-image {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            object-fit: cover;
        }

        .developer-details {
            width: 100%;
        }

        .developer-details p {
            margin: 12px 0;
            line-height: 1.5;
        }

        /* Settings */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .camera-settings {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .add-camera-btn, .remove-camera-btn, .save-settings-btn {
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .add-camera-btn {
            background: #001f3f;
            color: white;
            width: 100%;
            margin-top: 8px;
        }

        .remove-camera-btn {
            background: #f44336;
            color: white;
            width: 100%;
            margin-top: 8px;
        }

        .save-settings-btn {
            background: #4CAF50;
            color: white;
            width: 100%;
            margin-top: 16px;
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .image-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.75rem;
        }

        /* Type Badges */
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .type-smoking {
            background-color: #ffcccc;
            color: #cc0000;
        }

        .type-carrying {
            background-color: #cce5ff;
            color: #0066cc;
        }
        
        .item-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 4px;
        }

        .item-cigarette {
            background-color: #ffddcc;
            color: #cc5500;
        }

        .item-vape {
            background-color: #ccddff;
            color: #0044cc;
        }

        /* Swipeable tabs */
        .tabs-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: #001f3f;
            border-bottom: 2px solid #001f3f;
        }

        .tabs-content {
            display: flex;
            transition: transform 0.3s ease;
        }

        .tab-content {
            min-width: 100%;
            padding: 16px;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #001f3f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #ccc;
        }
        
        /* Image Preview Modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }
        
        .image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .image-preview-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        
        .image-preview-actions {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        
        .preview-action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Detection item in list */
        .detection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detection-info {
            flex: 1;
        }
        
        .detection-time {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .detection-location {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .detection-badges {
            display: flex;
            gap: 6px;
        }
        
        .detection-confidence {
            font-weight: bold;
            color: #001f3f;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Status Bar (simulated) -->
        <div class="status-bar"></div>
        
        <!-- Top Navigation Bar -->
        <div class="top-nav">
            <button class="menu-btn" onclick="toggleMenu()">☰</button>
            <img src="https://cdn-icons-png.flaticon.com/256/998/998699.png" alt="Logo" class="logo">
            <h1>Smoking Detection</h1>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Detection History Card -->
            <div class="card">
                <h2>Recent Detections</h2>
                <div class="tabs-container">
                    <div class="tabs-header">
                        <div class="tab active" onclick="switchTab(0)">List</div>
                        <div class="tab" onclick="switchTab(1)">Map</div>
                    </div>
                    <div class="tabs-content" id="tabs-content">
                        <div class="tab-content">
                            <div id="detection-list">
                                <!-- Detection items will be added here dynamically -->
                                <div class="loading">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                            <button class="view-all-btn" onclick="viewAllData()">View All History</button>
                        </div>
                        <div class="tab-content">
                            <div class="empty-state">
                                <div class="empty-icon">🗺️</div>
                                <p>Map view will be available soon</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Detection Card -->
            <div class="card">
                <h2>Latest Detection</h2>
                <img id="recent-image" src="" alt="Recent Image" onclick="previewImage('recent')">
                <div id="recent-image-info">
                    <p id="recent-image-time"></p>
                    <p id="recent-image-location"></p>
                    <p id="recent-image-type"></p>
                    <p id="recent-image-item"></p>
                </div>
                <button class="view-all-btn" onclick="viewAllImages()">View All Images</button>
            </div>

            <!-- Detection Statistics Card -->
            <div class="card">
                <h2>Detection Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-detections">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="smoking-detections">0</div>
                        <div class="stat-label">Smoking</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="carrying-detections">0</div>
                        <div class="stat-label">Carrying</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="last-detection-time">-</div>
                        <div class="stat-label">Last Detection</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" onclick="viewAllData(); return false;">
                <span class="nav-icon">📋</span>
                <span>History</span>
            </a>
            <a href="#" class="nav-item" onclick="viewAllImages(); return false;">
                <span class="nav-icon">🖼️</span>
                <span>Images</span>
            </a>
            <a href="#" class="nav-item" onclick="showSettings(); return false;">
                <span class="nav-icon">⚙️</span>
                <span>Settings</span>
            </a>
        </div>

        <!-- Developer Info Modal -->
        <div class="modal-overlay" id="developer-info-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Developer Information</h2>
                    <button class="modal-close" onclick="closeModal('developer-info-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="developer-content">
                        <img src="src/ayesha.jfif.jpg" alt="Developer Image" class="developer-image">
                        <div class="developer-details">
                            <p><strong>Name:</strong> Ayesha I. Maligalig</p>
                            <p><strong>Email:</strong> maligaligayesha21@gmail.com</p>
                            <p><strong>Phone:</strong> +639943763189</p>
                            <p><strong>Role:</strong> Lead Researcher</p>
                            <p><strong>About:</strong> Ayesha, 14 years old, is a high school student who's passionate about technology and innovation. She attends  Doroteo S. Mendoza Sr. Memorial National High School and enjoys exploring the science behind emerging technologies, with a keen interest in projects that apply AI and IoT for practical health and safety solutions.</p>
                        </div>
				<div class="modal-body">
                    <div class="developer-content">
                        <img src="src/justin.jfif" alt="Developer Image" class="developer-image">
                        <div class="developer-details">
                            <p><strong>Name:</strong> Justin Matthew M. Umali</p>
                            <p><strong>Email:</strong> justinumali009@gmail.com</p>
                            <p><strong>Phone:</strong> +639926524030</p>
                            <p><strong>Role:</strong> Researcher</p>
                            <p><strong>About:</strong> Justin is a 13 year old researcher from Doroteo S. Mendoza Sr. Memorial National High School. He is interested in technology do he learned and make some. 
stin is a 13 year old researcher from Doroteo S. Mendoza Sr. Memorial National High School. He is interested in technology do he learned and make some.</p>
                      
                </div>
				<div class="modal-body">
                    <div class="developer-content">
                        <img src="src/harvey.jfif" alt="Developer Image" class="developer-image">
                        <div class="developer-details">
                            <p><strong>Name:</strong> Evan Harvey O. Manalo</p>
                            <p><strong>Email:</strong> harveymanalo12@gmail.com</p>
                            <p><strong>Phone:</strong> +639945007897</p>
                            <p><strong>Role:</strong> Researcher</p>
                            <p><strong>About:</strong> Harvey is a 13 year old student from Doroteo S. Mendoza SR. Memorial National Highschool.He is very interested in technology and the science behind it.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settings-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">System Settings</h2>
                    <button class="modal-close" onclick="closeModal('settings-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="alert-phone">Alert Phone Number:</label>
                            <input type="tel" id="alert-phone" placeholder="+639123456789">
                        </div>
                        
                        <h3>Camera Configuration</h3>
                        <div id="camera-settings-container">
                            <!-- Camera settings will be added here dynamically -->
                        </div>
                        <button class="add-camera-btn" onclick="addCameraSetting()">Add Camera</button>
                        <button class="save-settings-btn" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data History Modal -->
        <div class="modal-overlay" id="data-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">All Detection History</h2>
                    <button class="modal-close" onclick="closeModal('data-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="all-data-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Item</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="all-data-table-body"></tbody>
                        </table>
                    </div>
                    <button class="view-all-btn" onclick="downloadData()">Download Data</button>
                </div>
            </div>
        </div>

        <!-- Images Modal -->
        <div class="modal-overlay" id="images-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">All Detection Images</h2>
                    <button class="modal-close" onclick="closeModal('images-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="image-grid" id="image-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- Image Preview Modal -->
        <div class="image-preview-modal" id="image-preview-modal">
            <div class="image-preview-content">
                <img id="preview-image" src="" alt="Preview">
                <button class="close-preview" onclick="closeImagePreview()">&times;</button>
                <div class="image-preview-actions">
                    <button class="preview-action-btn" onclick="zoomIn()">➕</button>
                    <button class="preview-action-btn" onclick="zoomOut()">➖</button>
                    <button class="preview-action-btn" onclick="downloadPreviewImage()">📥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCK7sNHt1NCAdT5Oh3UyqANkXmNNSbc138",
            authDomain: "smoke-detection-3c903.firebaseapp.com",
            databaseURL: "https://smoke-detection-3c903-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smoke-detection-3c903",
            storageBucket: "smoke-detection-3c903.firebasestorage.app",
            messagingSenderId: "934647950927",
            appId: "1:934647950927:web:ecb337451b9a8b6c2f043a"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Camera settings
        let cameraSettings = [];
        let currentTab = 0;
        let currentPreviewImage = null;
        let currentPreviewData = null;
        let zoomLevel = 1;

        function switchTab(tabIndex) {
            currentTab = tabIndex;
            const tabsContent = document.getElementById('tabs-content');
            tabsContent.style.transform = `translateX(-${tabIndex * 100}%)`;
            
            // Update active tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        function fetchDashboardData() {
            const dataRef = db.ref('smoking_events');
            dataRef.orderByChild('timestamp').limitToLast(5).on('value', (snapshot) => {
                const data = snapshot.val();
                const detectionList = document.getElementById('detection-list');
                detectionList.innerHTML = '';
                
                if (data) {
                    const entries = Object.entries(data).reverse();
                    
                    entries.forEach(([key, entry]) => {
                        const confidencePercent = (entry.confidence * 100).toFixed(0);
                        const typeBadge = getTypeBadge(entry.offense_type);
                        const itemBadge = getItemBadge(entry.offense_details?.item);
                        
                        const detectionItem = document.createElement('div');
                        detectionItem.className = 'detection-item';
                        detectionItem.innerHTML = `
                            <div class="detection-info">
                                <div class="detection-time">${formatTime(entry.timestamp)}</div>
                                <div class="detection-location">${entry.location}</div>
                                <div class="detection-badges">
                                    ${typeBadge}
                                    ${itemBadge}
                                </div>
                            </div>
                            <div class="detection-confidence">${confidencePercent}%</div>
                        `;
                        detectionList.appendChild(detectionItem);
                    });

                    // Update recent image
                    if (entries.length > 0) {
                        const recentData = entries[0][1];
                        document.getElementById('recent-image').src = `data:image/jpeg;base64,${recentData.image_base64}`;
                        document.getElementById('recent-image-time').innerText = `Captured: ${formatDateTime(recentData.timestamp)}`;
                        document.getElementById('recent-image-location').innerText = `Location: ${recentData.location}`;
                        document.getElementById('recent-image-type').innerHTML = `Type: ${getTypeBadge(recentData.offense_type)}`;
                        document.getElementById('recent-image-item').innerHTML = `Item: ${getItemBadge(recentData.offense_details?.item)}`;
                    }
                    
                    // Update statistics
                    updateStatistics(data);
                } else {
                    detectionList.innerHTML = '<div class="empty-state"><div class="empty-icon">🔍</div><p>No detection data available</p></div>';
                }
            });
        }

        function updateStatistics(data) {
            const entries = Object.values(data);
            const totalDetections = entries.length;
            const smokingDetections = entries.filter(entry => entry.offense_type === 'smoking').length;
            const carryingDetections = entries.filter(entry => entry.offense_type === 'carrying').length;
            
            // Get the latest detection time
            let lastDetectionTime = '-';
            if (entries.length > 0) {
                const timestamps = entries.map(entry => new Date(entry.timestamp));
                const latestTimestamp = new Date(Math.max(...timestamps));
                lastDetectionTime = formatTime(latestTimestamp);
            }
            
            document.getElementById('total-detections').innerText = totalDetections;
            document.getElementById('smoking-detections').innerText = smokingDetections;
            document.getElementById('carrying-detections').innerText = carryingDetections;
            document.getElementById('last-detection-time').innerText = lastDetectionTime;
        }

        function getTypeBadge(type) {
            if (!type) return '';
            
            const classMap = {
                'smoking': 'type-smoking',
                'carrying': 'type-carrying'
            };
            
            const displayText = type === 'smoking' ? 'Smoking' : 'Carrying';
            return `<span class="type-badge ${classMap[type] || ''}">${displayText}</span>`;
        }

        function getItemBadge(item) {
            if (!item) return '';
            
            const classMap = {
                'cigarette': 'item-cigarette',
                'vape': 'item-vape'
            };
            
            const displayText = item === 'cigarette' ? 'Cigarette' : 'Vape';
            return `<span class="item-badge ${classMap[item] || ''}">${displayText}</span>`;
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        function viewAllData() {
            const dataRef = db.ref('smoking_events');
            dataRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const tableBody = document.getElementById('all-data-table-body');
                tableBody.innerHTML = '';
                
                if (data) {
                    Object.entries(data).reverse().forEach(([key, entry]) => {
                        const confidencePercent = (entry.confidence * 100).toFixed(0);
                        const typeBadge = getTypeBadge(entry.offense_type);
                        const itemBadge = getItemBadge(entry.offense_details?.item);
                        
                        const row = `<tr>
                                        <td>${formatDateTime(entry.timestamp)}</td>
                                        <td>${entry.location}</td>
                                        <td>${typeBadge}</td>
                                        <td>${itemBadge}</td>
                                        <td>${confidencePercent}%</td>
                                    </tr>`;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No detection data available</td></tr>';
                }
                
                showModal('data-modal');
            });
        }

        function viewAllImages() {
            const dataRef = db.ref('smoking_events');
            dataRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const imageGrid = document.getElementById('image-grid');
                imageGrid.innerHTML = '';
                
                if (data) {
                    Object.entries(data).reverse().forEach(([key, entry]) => {
                        const confidencePercent = (entry.confidence * 100).toFixed(0);
                        const typeBadge = getTypeBadge(entry.offense_type);
                        const itemBadge = getItemBadge(entry.offense_details?.item);
                        
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-item';
                        imageItem.innerHTML = `
                            <img src="data:image/jpeg;base64,${entry.image_base64}" alt="Detection image" 
                                 onclick="previewImage('${key}', '${entry.image_base64}', ${entry.confidence}, '${entry.offense_type}', '${entry.offense_details?.item}', '${entry.timestamp}', '${entry.location}')">
                            <div class="image-info">
                                ${formatTime(entry.timestamp)}<br>
                                ${typeBadge} ${itemBadge} ${confidencePercent}%
                            </div>
                        `;
                        imageGrid.appendChild(imageItem);
                    });
                } else {
                    imageGrid.innerHTML = '<div class="empty-state"><div class="empty-icon">🖼️</div><p>No images available</p></div>';
                }
                
                showModal('images-modal');
            });
        }

        function previewImage(id, imageBase64, confidence, type, item, timestamp, location) {
            if (id === 'recent') {
                // Use the recent image data
                const recentImage = document.getElementById('recent-image');
                if (recentImage.src) {
                    currentPreviewImage = recentImage.src;
                    currentPreviewData = {
                        confidence: parseFloat(document.getElementById('recent-image').getAttribute('data-confidence')),
                        type: document.getElementById('recent-image').getAttribute('data-type'),
                        item: document.getElementById('recent-image').getAttribute('data-item'),
                        timestamp: document.getElementById('recent-image').getAttribute('data-timestamp'),
                        location: document.getElementById('recent-image').getAttribute('data-location')
                    };
                }
            } else {
                // Use the provided data
                currentPreviewImage = `data:image/jpeg;base64,${imageBase64}`;
                currentPreviewData = {
                    confidence: confidence,
                    type: type,
                    item: item,
                    timestamp: timestamp,
                    location: location
                };
            }
            
            document.getElementById('preview-image').src = currentPreviewImage;
            document.getElementById('image-preview-modal').style.display = 'flex';
            zoomLevel = 1;
            document.getElementById('preview-image').style.transform = `scale(${zoomLevel})`;
        }

        function closeImagePreview() {
            document.getElementById('image-preview-modal').style.display = 'none';
        }

        function zoomIn() {
            if (zoomLevel < 3) {
                zoomLevel += 0.25;
                document.getElementById('preview-image').style.transform = `scale(${zoomLevel})`;
            }
        }

        function zoomOut() {
            if (zoomLevel > 0.5) {
                zoomLevel -= 0.25;
                document.getElementById('preview-image').style.transform = `scale(${zoomLevel})`;
            }
        }

        function downloadPreviewImage() {
            if (!currentPreviewImage || !currentPreviewData) return;
            
            const link = document.createElement('a');
            link.href = currentPreviewImage;
            const confidencePercent = (currentPreviewData.confidence * 100).toFixed(0);
            const cleanTimestamp = currentPreviewData.timestamp ? 
                new Date(currentPreviewData.timestamp).toISOString().replace(/[:.]/g, '-') : 
                'unknown-time';
            link.download = `Detection_${currentPreviewData.type}_${currentPreviewData.item || 'unknown'}_${cleanTimestamp}_${confidencePercent}pc.jpg`;
            link.click();
        }

        function downloadData() {
            const table = document.getElementById('all-data-table');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Detection History");
            XLSX.writeFile(wb, "detection_history.xlsx");
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleMenu() {
            showDeveloperInfo();
        }

        function showDeveloperInfo() {
            showModal('developer-info-modal');
        }

        function showSettings() {
            // Load current settings
            db.ref('alert_settings').once('value').then((snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    document.getElementById('alert-phone').value = settings.phone_number || '';
                }
                
                return db.ref('camera_settings').once('value');
            }).then((snapshot) => {
                const settings = snapshot.val();
                const container = document.getElementById('camera-settings-container');
                container.innerHTML = '';
                
                if (settings) {
                    cameraSettings = Object.entries(settings).map(([id, setting]) => {
                        return { id, ...setting };
                    });
                    
                    cameraSettings.forEach((setting, index) => {
                        addCameraSettingToUI(setting, index);
                    });
                } else {
                    // Add default camera if none exist
                    addCameraSetting();
                }
                
                showModal('settings-modal');
            }).catch(error => {
                console.error("Error loading settings:", error);
            });
        }

        function addCameraSetting() {
            const newSetting = {
                id: `camera_${Date.now()}`,
                location: '',
                camera_index: cameraSettings.length
            };
            cameraSettings.push(newSetting);
            addCameraSettingToUI(newSetting, cameraSettings.length - 1);
        }

        function addCameraSettingToUI(setting, index) {
            const container = document.getElementById('camera-settings-container');
            const settingDiv = document.createElement('div');
            settingDiv.className = 'camera-settings';
            settingDiv.id = `camera-${setting.id}`;
            
            settingDiv.innerHTML = `
                <h4>Camera ${index + 1}</h4>
                <div class="form-group">
                    <label for="location-${setting.id}">Location:</label>
                    <input type="text" id="location-${setting.id}" value="${setting.location || ''}" placeholder="Enter camera location">
                </div>
                <div class="form-group">
                    <label for="index-${setting.id}">Camera Index:</label>
                    <select id="index-${setting.id}">
                        ${Array.from({length: 4}, (_, i) => 
                            `<option value="${i}" ${i === setting.camera_index ? 'selected' : ''}>${i}</option>`).join('')}
                    </select>
                </div>
                <button class="remove-camera-btn" onclick="removeCameraSetting('${setting.id}')">Remove Camera</button>
            `;
            
            container.appendChild(settingDiv);
        }

        function removeCameraSetting(id) {
            if (confirm('Are you sure you want to remove this camera?')) {
                cameraSettings = cameraSettings.filter(setting => setting.id !== id);
                const element = document.getElementById(`camera-${id}`);
                if (element) element.remove();
            }
        }

        function saveSettings() {
            const phoneNumber = document.getElementById('alert-phone').value;
            const updates = {};
            
            // Save phone number
            updates['alert_settings/phone_number'] = phoneNumber;
            
            // Save camera settings
            cameraSettings.forEach(setting => {
                const location = document.getElementById(`location-${setting.id}`).value;
                const index = parseInt(document.getElementById(`index-${setting.id}`).value);
                
                updates[`camera_settings/${setting.id}/location`] = location;
                updates[`camera_settings/${setting.id}/camera_index`] = index;
            });
            
            // Remove deleted cameras
            db.ref('camera_settings').once('value').then((snapshot) => {
                const existingSettings = snapshot.val() || {};
                const existingIds = Object.keys(existingSettings);
                const currentIds = cameraSettings.map(c => c.id);
                
                existingIds.forEach(id => {
                    if (!currentIds.includes(id)) {
                        updates[`camera_settings/${id}`] = null;
                    }
                });
                
                return db.ref().update(updates);
            }).then(() => {
                alert('Settings saved successfully!');
                closeModal('settings-modal');
            }).catch(error => {
                alert('Error saving settings: ' + error.message);
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'index.html';
            }
        }

        // Initialize the app
        window.onload = () => {
            fetchDashboardData();
            switchTab(0);
        };

        // Add touch events for swipeable tabs
        let startX = 0;
        let currentX = 0;
        const tabsContent = document.getElementById('tabs-content');

        tabsContent.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
        });

        tabsContent.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
        });

        tabsContent.addEventListener('touchend', () => {
            const diff = startX - currentX;
            if (Math.abs(diff) > 50) { // Minimum swipe distance
                if (diff > 0 && currentTab < 1) {
                    switchTab(currentTab + 1);
                } else if (diff < 0 && currentTab > 0) {
                    switchTab(currentTab - 1);
                }
            }
        });
    </script>
</body>
</html>
